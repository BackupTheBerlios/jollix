#!/bin/sh
# Moduleloader
# Copyright 2003 jollix
# Jochen Spang <knochestolle@web.de>
# Oliver Schwinn <patteh@web.de> 
# location in cloop: /sbin/modules-jollix
# Distributed under the terms of the GNU General Public License, v2 or later

# load all modules
for module in $(pcimodules) ; do
 modprobe -s -k "$module"
done

# test nvidia module
modprobe -q nvidia
nvidiafound=0
for module in $(lsmod) ; do
  if [ "$module" = "nvidia" ] ; then
   nvidiafound=1
  fi
done

# test fglrx module
if [ $nvidiafound = 0 ] ; then
 modprobe -q fglrx
 fglrxfound=0
 for module in $(lsmod) ; do
   if [ "$module" = "fglrx" ] ; then
    fglrxfound=1
   fi
 done
fi

# vesa safemode
if [ $nvidiafound = 0 ] ; then
 if [ $fglrxfound = 0 ] ; then
  cp /etc/X11/XF86Config-vesa /etc/X11/XF86Config
  opengl-update xfree
 fi
fi

# switch to nvidia
if [ $nvidiafound = 1 ] ; then
 cp /etc/X11/XF86Config-nvidia /etc/X11/XF86Config
 opengl-update nvidia
fi

# switch to ati
if [ $fglrxfound = 1 ] ; then
 cp /etc/X11/XF86Config-ati /etc/X11/XF86Config
 opengl-update ati
fi

# load oss
for module in $(lsmod) ; do
  if [ "$module" = "snd" ] ; then
   modprobe snd-pcm-oss
  fi
done

# unmute alsa
amixer set Master 25 unmute
amixer set PCM 25 unmute

# USB PS/2 mouse configuration
# wait 5 sec. for usb/devices to be created (hackattack!)

raushier=true
declare -i counter=0
while $raushier ; do
 if grep -i "mouse" /proc/bus/usb/devices >/dev/null
  then
   raushier=false 
  else
   counter=${counter}+1
   echo -n .
   sleep 1 
 fi
 if [ $counter = 5 ]
  then
   raushier=false
 fi
done

if grep -i "mouse" /proc/bus/usb/devices >/dev/null 
 then 
  sed -i -e 's/psaux/input\/mice/' /etc/X11/XF86Config
else
  sed -i -e 's/input\/mice/psaux/' /etc/X11/XF86Config  
fi
